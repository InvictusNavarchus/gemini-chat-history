# ‚ú® Gemini Chat History Manager ‚ú®

**Version:** `0.8.1`

A userscript designed to automatically track Google Gemini chat sessions initiated from the base application URL. It locally stores metadata associated with each new chat and provides options for exporting this data.

---

## üöÄ Features

* **Automatic History Tracking:** Captures metadata when a *new* chat session is initiated via the send button on `https://gemini.google.com/app`.
* **Comprehensive Metadata Capture:** Stores key details for each tracked chat:
    * `timestamp`: When the initial prompt was sent (ISO 8601 format, localized).
    * `url`: The unique URL assigned to the chat session.
    * `title`: The chat title generated by Gemini (handles async loading).
    * `model`: The Gemini model detected (e.g., `2.5 Pro`).
    * `prompt`: Initial user prompt text (code blocks truncated).
    * `attachedFiles`: Array of attached filenames.
    * `accountName` & `accountEmail`: Google Account details associated with the session.
* **Local Storage:** Uses the userscript manager's `GM_setValue`/`GM_getValue` for persistence.
* **Data Export:** Provides user menu commands for:
    * Exporting history to a `.json` file. üìÑ
    * Viewing history `JSON` directly in a new tab. üëÅÔ∏è
* **Status Indicator:** Displays transient visual feedback (saving, exporting, errors) in the bottom-right corner. üí¨
* **Duplicate Prevention:** Avoids adding entries with the same chat URL. ‚úÖ
* **Robust Detection:** Attempts multiple UI selectors to find the model name, title, etc.

---

## ‚öôÔ∏è How it Works

The script operates through a sequence of event listening and DOM observation:

1.  **Event Listening:** Attaches a click listener to `document.body` (capture phase).
2.  **Send Button Identification:** On click, checks if the target is the "Send" button on the base `https://gemini.google.com/app` URL (indicating a *new* chat). Ignores disabled buttons.
3.  **Pre-Navigation Data Capture:** If a new chat is detected, *immediately* captures:
    * Selected Gemini model (`ModelDetector.getCurrentModelName()`)
    * Prompt text (`InputExtractor.getPromptText()`)
    * Attached filenames (`InputExtractor.getAttachedFiles()`)
    * Account info (`InputExtractor.getAccountInfo()`)
    * Sets an internal flag (`STATE.isNewChatPending`).
4.  **Sidebar Observation:** Initiates a `MutationObserver` (`DomObserver.observeSidebarForNewChat`) targeting the chat list sidebar (`conversations-list[data-test-id="all-conversations"]`).
5.  **New Chat Item Detection:** Waits for a new `div[data-test-id="conversation"]` to appear in the sidebar *after* the browser navigates to the new chat's unique URL. Verifies the URL pattern.
6.  **Context Finalization:** Once the item appears and URL is confirmed:
    * Records the current timestamp (`Utils.getCurrentJakartaTimestamp()`).
    * Captures the final chat `url` (`window.location.href`).
    * Disconnects the main sidebar observer.
7.  **Title Observation:** Attaches a *second* `MutationObserver` (`DomObserver.observeTitleForItem`) to the specific new sidebar item, monitoring it for changes (waiting for the title to be populated asynchronously).
8.  **Title Extraction & Storage:** When the title observer detects a relevant change:
    * Extracts the title text (`DomObserver.extractTitleFromSidebarItem`).
    * If successful and URL still matches, disconnects the title observer.
    * Constructs the complete history entry object.
    * Calls `HistoryManager.addHistoryEntry` to save the entry via `GM_setValue` (checking for duplicates).
    * Shows a success message via the status indicator. ‚úÖ
9.  **Export/View:** Menu commands retrieve history via `GM_getValue`, serialize to JSON, create a Blob, and trigger a download or open a new tab.

---

## üì• Installation

> [!IMPORTANT]
> You **must** have a userscript manager browser extension installed first.

1.  **Install a Userscript Manager:** Choose one compatible with your browser:
    * [Tampermonkey](https://www.tampermonkey.net/) (Recommended: Chrome, Firefox, Edge, Safari, Opera)
    * [Violentmonkey](https://violentmonkey.github.io/) (Chrome, Firefox, Edge)
    * [Greasemonkey](https://www.greasespot.net/) (Firefox)
2.  **Install the Script:** Click the direct installation link below:
    * ‚û°Ô∏è [**Install Gemini Chat History Manager**](https://raw.githubusercontent.com/InvictusNavarchus/gemini-chat-history/master/gemini-chat-history.user.js) ‚¨ÖÔ∏è
3.  **Confirm Installation:** Your userscript manager will intercept the `.user.js` file and prompt you to install. Review the requested permissions (`@grant` list) and confirm.

---

## üõ†Ô∏è Usage

* **Automatic Tracking:** Simply start a *new* chat on Google Gemini (`https://gemini.google.com/app`) and click send. The script works automatically in the background.
* **Accessing Menu Commands:**
    1.  Navigate to any page on `https://gemini.google.com/*`.
    2.  Click your userscript manager's icon in the browser toolbar.
    3.  Select one of the commands:
        * `View Gemini Chat History JSON`: Opens history JSON in a new tab.
        * `Export Gemini Chat History to JSON`: Downloads the history as a `.json` file.

> [!TIP]
> Keep an eye on the bottom-right corner for the status indicator messages confirming actions like saving or exporting!

---

## üíæ Data Stored

The script stores chat history locally using your userscript manager's storage.

* **Storage Method:** `GM_setValue` / `GM_getValue`
* **Storage Key:** `geminiChatHistory`
* **Format:** JSON Array (`[...]`) where each element is an object representing a chat session.

**Stored Fields per Chat:**

| Field           | Type           | Description                                                                 |
| :-------------- | :------------- | :-------------------------------------------------------------------------- |
| `timestamp`     | String         | ISO 8601 timestamp when the first prompt was sent (e.g., "2025-05-02T08:02:41") |
| `url`           | String         | The full, unique URL of the chat session.                                     |
| `title`         | String         | The chat title generated by Gemini.                                         |
| `model`         | String         | The detected Gemini model name (e.g., "2.5 Pro").                           |
| `prompt`        | String         | The initial user prompt text (may be truncated if code blocks are present). |
| `attachedFiles` | Array<String>  | List of filenames attached to the initial prompt.                           |
| `accountName`   | String         | Name associated with the logged-in Google Account.                          |
| `accountEmail`  | String         | Email associated with the logged-in Google Account.                         |

---

## üîß Configuration

* **Timezone:**
    > [!WARNING]
    > The timestamp localization is hardcoded to `Asia/Jakarta` in the `CONFIG.TIMEZONE` constant. To change this, you must **manually edit the installed script** and replace `'Asia/Jakarta'` with a valid [IANA time zone name](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones) (e.g., `'America/New_York'`, `'Europe/London'`, `'UTC'`).
* **Storage Key:** The key `geminiChatHistory` is defined in `CONFIG.STORAGE_KEY`. Changing this constant in the script will cause it to use a different storage entry (effectively starting a new, separate history).

---

## üîó Dependencies

* A compatible web browser (Chrome, Firefox, Edge, etc.).
* An installed and enabled userscript manager extension (Tampermonkey, Violentmonkey, etc.).

> [!NOTE]
> The metadata includes `@require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@2`, but the current core logic primarily uses standard browser `MutationObserver` APIs, not specific `@violentmonkey/dom` functions like `VM.observe`.

---

## ‚ö†Ô∏è Known Issues and Limitations

* **New Chats Only:** **Crucially,** the script *only* tracks chats newly initiated from `https://gemini.google.com/app`. It does **not** track interactions within existing chats loaded directly, nor does it capture history retroactively.
* **UI Fragility:** Relies heavily on specific HTML structure, CSS classes, and `data-test-id` attributes in the Gemini interface. **Changes by Google to the Gemini website will likely break the script.**
* **Model Detection:** May fail if Gemini changes how model names are displayed or uses unrecognized formats. Falls back to 'Unknown' or raw text.
* **Title Capture Timing:** Depends on Gemini's asynchronous title loading behavior. Changes could prevent title capture.
* **Prompt Truncation:** Code block (` ``` `) detection is basic and stops at the first instance.
* **Account Info Extraction:** Depends on the specific `aria-label` format of the account menu button.
* **Error Handling:** Primarily logs to console and uses the status indicator; no automatic retry logic.

---

## üìú License

Licensed under GNU General Public License v3