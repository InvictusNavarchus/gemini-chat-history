# Gemini Chat History Manager

**Version:** 0.8.1

A userscript designed to automatically track Google Gemini chat sessions initiated from the base application URL. It locally stores metadata associated with each new chat and provides options for exporting this data.

## Features

* **Automatic History Tracking:** Captures metadata when a *new* chat session is initiated via the send button on `https://gemini.google.com/app`.
* **Comprehensive Metadata Capture:** Stores the following information for each tracked chat:
    * `timestamp`: The date and time the initial prompt was sent (ISO 8601 format, localized to `Asia/Jakarta` by default).
    * `url`: The unique URL assigned to the Gemini chat session upon creation.
    * `title`: The chat title generated by Gemini (handles asynchronous loading via MutationObserver).
    * `model`: The Gemini model detected (e.g., `2.5 Pro`, `2.0 Flash`) at the time the first prompt was sent. Attempts multiple UI selectors for robustness.
    * `prompt`: The text content of the initial user prompt. If the prompt contains triple backticks (\`\`\`), the text is truncated before the backticks, and `[attached blockcode]` is appended.
    * `attachedFiles`: An array of filenames for any files attached to the initial prompt.
    * `accountName`: The name associated with the active Google Account, extracted from the UI.
    * `accountEmail`: The email address associated with the active Google Account, extracted from the UI.
* **Local Storage:** Utilizes the userscript manager's `GM_setValue` and `GM_getValue` functions for persistent storage of the history data within the browser's extension storage.
* **Data Export:** Provides user menu commands (`GM_registerMenuCommand`) to:
    * Export the entire tracked history to a timestamped `.json` file.
    * View the history data as formatted JSON directly in a new browser tab.
* **Status Indicator:** Displays transient visual feedback in the bottom-right corner of the page regarding script operations (e.g., tracking started, chat saved, export initiated, errors encountered).
* **Duplicate Prevention:** Avoids adding duplicate entries based on the unique chat URL.

## How it Works

1.  **Event Listening:** The script attaches a click event listener to the `document.body` (using the capture phase) to detect clicks.
2.  **Send Button Identification:** When a click occurs, it checks if the target element is, or is within, the chat interface's "Send" button *and* if the current page URL is the base Gemini application URL (`https://gemini.google.com/app` possibly with query parameters). This signifies the start of a *new* chat. Disabled buttons are ignored.
3.  **Pre-Navigation Data Capture:** If a new chat initiation is detected, the script immediately captures the current state *before* the page potentially navigates:
    * Detects the selected Gemini model using `ModelDetector.getCurrentModelName()`.
    * Extracts the prompt text using `InputExtractor.getPromptText()`.
    * Extracts attached filenames using `InputExtractor.getAttachedFiles()`.
    * Extracts account information using `InputExtractor.getAccountInfo()`.
    * Sets an internal flag (`STATE.isNewChatPending`) to true.
4.  **Sidebar Observation:** A `MutationObserver` (`DomObserver.observeSidebarForNewChat`) is initiated to monitor the chat list sidebar (`conversations-list[data-test-id="all-conversations"]`) for newly added child nodes.
5.  **New Chat Item Detection:** The observer waits for a new conversation item (`div[data-test-id="conversation"]` within a `conversation-items-container`) to be added to the sidebar *after* the browser likely navigates to the new chat's unique URL (e.g., `https://gemini.google.com/app/xxxxxxxxxxxxxxxxx`). The script verifies the URL matches the expected pattern.
6.  **Context Finalization:** Once the new sidebar item is detected and the URL is confirmed:
    * The current timestamp is recorded using `Utils.getCurrentJakartaTimestamp()`.
    * The final chat `url` (window.location.href) is captured.
    * The main sidebar observer is disconnected.
7.  **Title Observation:** A *second* `MutationObserver` (`DomObserver.observeTitleForItem`) is attached specifically to the newly added conversation item in the sidebar. This observer monitors the item for subtree modifications, character data changes, or attribute changes, waiting for Gemini to asynchronously populate the chat title (`.conversation-title`).
8.  **Title Extraction & Storage:** When the title observer detects a change, it attempts to extract the title text using `DomObserver.extractTitleFromSidebarItem`.
    * If a valid title is extracted and the current URL still matches the expected chat URL:
        * The title observer is disconnected.
        * A complete history entry object is created using the timestamp, URL, extracted title, and the previously captured model, prompt, files, and account info.
        * `HistoryManager.addHistoryEntry` is called to add the entry to the history array (stored via `GM_setValue`), preventing duplicates based on URL.
        * A success message is shown via the status indicator.
    * If the URL changes before the title is captured, the title observer is disconnected to prevent incorrect association.
9.  **Export/View:** The `Export Gemini Chat History to JSON` and `View Gemini Chat History JSON` menu commands retrieve the history array using `GM_getValue`, serialize it to JSON, create a Blob, generate an object URL, and then either trigger a download or open the URL in a new tab.

## Installation

1.  **Install a Userscript Manager:** You need a browser extension capable of running userscripts, such as:
    * [Tampermonkey](https://www.tampermonkey.net/) (Recommended: Chrome, Firefox, Edge, Safari, Opera)
    * [Violentmonkey](https://violentmonkey.github.io/) (Chrome, Firefox, Edge, Maxthon)
    * [Greasemonkey](https://www.greasespot.net/) (Firefox)
2.  **Install the Script:** Click the installation link below:
    * [**Install Gemini Chat History Manager**](https://raw.githubusercontent.com/InvictusNavarchus/gemini-chat-history/master/gemini-chat-history.user.js)
3.  **Confirm Installation:** Your userscript manager should detect the script from the link and prompt you to confirm the installation. Review the permissions (`@grant` values) and install.

## Usage

* **Automatic Tracking:** No action is required for tracking. Simply start a *new* chat on Google Gemini by typing a prompt on `https://gemini.google.com/app` and clicking the send button. The script will automatically attempt to capture the details once the chat is created and the title appears in the sidebar.
* **Accessing Menu Commands:**
    1.  Navigate to any page on `https://gemini.google.com/*`.
    2.  Click on your userscript manager's icon in your browser's toolbar.
    3.  Under the "Userscript Commands" section (or similar), you will find:
        * `View Gemini Chat History JSON`: Opens the stored history data as formatted JSON in a new browser tab.
        * `Export Gemini Chat History to JSON`: Initiates a download of the history data as a `.json` file (e.g., `gemini_chat_history_YYYY-MM-DDTHH-mm-ss-sssZ.json`).
* **Status Indicator:** Observe the small notification panel that appears in the bottom-right corner for feedback on the script's actions (saving, exporting, potential errors).

## Data Stored

The script stores the chat history locally using the userscript manager's storage mechanism (`GM_setValue`). This data is typically stored within the browser extension's sandboxed storage area. The data format is a JSON array where each element is an object with the following keys:

* `timestamp` (String): ISO 8601 timestamp (e.g., "2025-05-02T08:02:41").
* `url` (String): The full URL of the chat (e.g., "https://gemini.google.com/app/123abc456def").
* `title` (String): The chat title.
* `model` (String): The detected model name (e.g., "2.5 Pro").
* `prompt` (String): The initial user prompt text (potentially truncated).
* `attachedFiles` (Array of Strings): List of attached filenames.
* `accountName` (String): Google Account name.
* `accountEmail` (String): Google Account email.

The storage key used is `geminiChatHistory`.

## Configuration

* **Timezone:** The timestamp localization is currently hardcoded to `Asia/Jakarta` within the `CONFIG.TIMEZONE` constant in the script's source code. To change this, you must manually edit the script and replace `'Asia/Jakarta'` with a valid IANA time zone name (e.g., `'America/New_York'`, `'Europe/London'`, `'UTC'`).
* **Storage Key:** The key used for `GM_setValue`/`GM_getValue` is defined in `CONFIG.STORAGE_KEY`. Modifying this will cause the script to use a different storage entry, effectively starting a new history.

## Dependencies

* A compatible web browser (Chrome, Firefox, Edge, etc.).
* An installed and enabled userscript manager extension (Tampermonkey, Violentmonkey, etc.).
* The `@require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@2` directive is present in the metadata, intended for the `VM.observe` utility. However, the current implementation primarily uses standard browser `MutationObserver` APIs.

## Known Issues and Limitations

* **New Chats Only:** The script *only* tracks chats that are newly initiated from `https://gemini.google.com/app`. It does not track interactions within existing chats loaded directly via their URL, nor does it capture history retroactively.
* **UI Dependency:** The script relies heavily on the specific HTML structure, CSS class names, and `data-test-id` attributes present in the Google Gemini web interface. Changes to the Gemini website's frontend code are likely to break the script's functionality (e.g., inability to find the send button, model name, prompt area, sidebar items, title element, or account information).
* **Model Detection:** Model name detection depends on predefined text patterns and selectors. If Gemini changes how models are displayed or introduces new models not matching known patterns, detection may fail (falling back to 'Unknown' or raw text).
* **Title Capture Timing:** Title capture depends on the title element (`.conversation-title`) being populated *after* the conversation item appears in the sidebar. Significant changes to this loading behavior could prevent titles from being captured correctly.
* **Prompt Truncation:** The truncation logic for prompts containing code blocks is basic; it stops at the first occurrence of triple backticks (\`\`\`).
* **Account Info Extraction:** Relies on parsing the `aria-label` attribute of the account menu button. Changes to this label's format will break extraction.
* **Error Handling:** Error handling primarily consists of logging messages to the browser's developer console and displaying messages via the status indicator. The script does not implement complex retry logic for failed captures.

## Contributing

Contributions (bug reports, feature requests, pull requests) are welcome. Please refer to the repository's issue tracker and contribution guidelines (if available).

## License

[Specify License Here - e.g., MIT License] or "See LICENSE file." (Assuming a license file exists or will be added).